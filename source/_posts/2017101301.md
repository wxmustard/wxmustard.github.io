---
title: 云盘(docker)创建＋nginx
author: mustard
date: 2017-10-13 22:29:10
tags:
  - docker
  - nginx
  - nextcloud
categories:
  - 技术
---

## docker创建云盘

* 在拓展硬盘上建立目录

  ```bash
  cd /home/extspace
  sudo mkdir nextcloud
  cd nextcloud
  sudo mkdir -p html/apps
  sudo mkdir -p html/config
  sudo mkdir -p html/data
  sudo mkdir db
  sudo mkdir -p html/custom_apps
  sudo mkdir -p html/themes
  ```

* 回到用户主目录创建目录

  ```bash
  cd ~
  mkdir nextcloud
  vim nextcloud/docker-compose.yml
  ```

  `docker-compose.yml` 配置如下：

  ```yml
  version: '2'

  services:
    db:
      image: mariadb
      restart: always
      volumes:
        - /home/extspace/nextcloud/db:/var/lib/mysql
      environment:
        - MYSQL_ROOT_PASSWORD=centos
        - MYSQL_PASSWORD=centos
        - MYSQL_DATABASE=nextcloud
        - MYSQL_USER=nextcloud

    app:
      image: nextcloud
      ports:
        - 10080:80
      links:
        - db
      volumes:
        - /home/extspace/nextcloud/data:/var/www/html/data
        - /home/extspace/nextcloud/config:/var/www/config
        - /home/extspace/nextcloud/apps:/var/www/html/apps
      restart: always
      environment:
        - NEXTCLOUD_ADMIN_USER=admin
        - NEXTCLOUD_ADMIN_PASSWORD=admin
  ```

* 拷贝`config`文件夹

  ```bash
  # 用docker-compose启动
  sudo docker-compose up -d
  # 使用bash方式进入某个具体的容器
  sudo docker exec -ti nextcloud_app_1 /bin/bash
  # 拷贝config
  cp -R /var/www/html/config/* /var/www/config

  # config文件夹中包含以下五个文件
  # apache-pretty-urls.config.php  apps.config.php  config.sample.php
  # apcu.config.php                autoconfig.php

  # 修改docker-compose.yml文件
  - /home/extspace/nextcloud/config:/var/www/html/config
  # 再次启动配置文件 
  sudo docker-compose up -d
  ```

* 浏览器访问`lab2:10080`进行初始化设置，数据库名字一定要输入`db`。

## nginx 

* ```bash
  sudo apt install nginx
  cd /etc/nginx/sites-available
  sudo cp default yun.shyun.tk
  ```

* `/etc/nginx/proxy.conf`

  ```bash
  vim /etc/nginx/proxy.conf

  # 文件内容如下
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header Host $http_host;
  proxy_set_header X-NginX-Proxy true;

  proxy_redirect off;

  # Socket.IO Support
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  ```

* `yun.shyun.tk`配置文件如下

  ```bash
  ##
  # You should look at the following URL's in order to grasp a solid understanding
  # of Nginx configuration files in order to fully unleash the power of Nginx.
  # http://wiki.nginx.org/Pitfalls
  # http://wiki.nginx.org/QuickStart
  # http://wiki.nginx.org/Configuration
  #
  # Generally, you will want to move this file somewhere, and start with a clean
  # file but keep this around for reference. Or just disable in sites-enabled.
  #
  # Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
  ##

  # Default server configuration
  #
  server {
  	listen 80 ;
  	listen [::]:80 ;

  	# SSL configuration
  	#
  	# listen 443 ssl default_server;
  	# listen [::]:443 ssl default_server;
  	#
  	# Note: You should disable gzip for SSL traffic.
  	# See: https://bugs.debian.org/773332
  	#
  	# Read up on ssl_ciphers to ensure a secure configuration.
  	# See: https://bugs.debian.org/765782
  	#
  	# Self signed certs generated by the ssl-cert package
  	# Don't use them in a production server!
  	#
  	# include snippets/snakeoil.conf;

  	root /var/www/html;

  	# Add index.php to the list if you are using PHP
  	index index.html index.htm index.nginx-debian.html index.php;

  	server_name yun.shyun.tk;

  	location / {
  		# First attempt to serve request as file, then
  		# as directory, then fall back to displaying a 404.
  		try_files $uri @apache;
  	}
      
  	location @apache {
  		internal;
  		proxy_pass http://127.0.0.1:10080;
  		include proxy.conf;
      }
  	# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
  	#
  	#location ~ \.php$ {
  	#	include snippets/fastcgi-php.conf;
  	#
  	#	# With php7.0-cgi alone:
  	#	fastcgi_pass 127.0.0.1:9000;
  	#	# With php7.0-fpm:
  	#	fastcgi_pass unix:/run/php/php7.0-fpm.sock;
  	#}

  	# deny access to .htaccess files, if Apache's document root
  	# concurs with nginx's one
  	#
  	#location ~ /\.ht {
  	#	deny all;
  	#}
  }
  # Virtual Host configuration for example.com
  #
  # You can move that to a different file under sites-available/ and symlink that
  # to sites-enabled/ to enable it.
  #
  #server {
  #	listen 80;
  #	listen [::]:80;
  #
  #	server_name example.com;
  #
  #	root /var/www/example.com;
  #	index index.html;
  #
  #	location / {
  #		try_files $uri $uri/ =404;
  #	}
  #}
  ```

* 进入`sites-enabled`建立软连接

  ```bash
  cd /etc/nginx/sites-enabled 
  ln -s ../sites-availables/yun.shyun.tk 
  ```


* 未完待续


